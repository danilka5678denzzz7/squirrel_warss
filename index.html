<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Squirrel Wars - Prototyp v7.3 (Bot Text Fix)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* –û–±–Ω—É–ª–µ–Ω–∏–µ –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
        body, html {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
            overflow: hidden; 
        }

        #root {
            height: 100vh;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ–π –∏–≥—Ä—ã */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 500px; 
            margin: 0 auto;
            background-color: #222;
            background-image: url('images/bg_forest_main.png');
            background-size: cover;
            background-position: center;
        }

        /* 1. –•–µ–¥–µ—Ä (–®–∞–ø–∫–∞) */
        .header {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: none; 
            border-bottom: none; 
            flex-shrink: 0;
        }
        
        .header-user {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.1em;
            background: rgba(0, 0, 0, 0.6); 
            padding: 8px 18px; 
            border-radius: 25px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); 
            gap: 8px;
        }
        .header-user img {
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            border: 2px solid gold; 
            flex-shrink: 0;
        }
        
        .header-balance {
            font-size: 1.4em; 
            font-weight: bold;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.6); 
            padding: 8px 18px; 
            border-radius: 25px; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); 
            gap: 8px; 
        }
        .header-balance img {
            width: 40px; 
            height: 40px;
            object-fit: contain; 
            border-radius: 50%; 
            border: 2px solid rgba(255, 215, 0, 0.7); 
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.5); 
            flex-shrink: 0; 
        }

        /* 2. –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω (–º–µ–Ω—è–µ—Ç—Å—è) */
        .game-screen {
            flex-grow: 1;
            padding: 0; 
            overflow: hidden; 
            position: relative; 
        }
        
        .boost-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 0;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.2));
            border-radius: 10px;
            border-bottom: 3px solid gold;
        }
        .boost-header h2 {
            margin: 0;
            font-size: 1.8em;
            color: gold;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8), 0 0 10px rgba(255, 215, 0, 0.5);
            font-weight: 900;
            letter-spacing: 1px;
        }

        .golden-nut-container {
            position: absolute;
            width: 75px; 
            height: 75px;
            cursor: pointer;
            z-index: 50;
            filter: drop-shadow(0 0 8px gold);
            transition: top 1s ease-in-out, left 1s ease-in-out, opacity 0.3s; 
        }
        .golden-nut-container img {
            width: 100%;
            height: 100%;
            animation: floatBob 1.5s infinite alternate ease-in-out;
        }
        
        @keyframes floatBob {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-5px) rotate(2deg); }
        }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ê–∫—Ç–∏–≤–Ω—ã–π –±–æ–Ω—É—Å —Ç–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
        .active-bonus-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex; 
            justify-content: center;
            align-items: center; 
            
            padding: 8px 15px; /* –£–≤–µ–ª–∏—á–∏–ª –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –ø–∞–¥–¥–∏–Ω–≥ */
            background: rgba(255, 215, 0, 0.9);
            color: black;
            font-weight: 900; 
            
            border-radius: 5px;
            z-index: 60;
            animation: flash 0.5s infinite alternate;
            
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            white-space: nowrap; /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
        }
        
        /* –£–±–∏—Ä–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —Å—Ç–∏–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ —Å—Ç–æ–ª–±–µ—Ü */
        .bonus-indicator-item {
            display: inline-block; /* –¢–µ–ø–µ—Ä—å —ç—Ç–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ */
            text-align: center; 
            margin: 0; 
            font-size: 1.1em;
        }
        
        .bonus-indicator-item span {
             font-weight: 900; 
             margin-right: 5px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ –∑–Ω–∞—á–∫–∞ ‚ö°Ô∏è */
        }
        
        .bonus-indicator-subtext {
            font-size: 0.9em; /* –ß—É—Ç—å –º–µ–Ω—å—à–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ */
            font-weight: 900; /* –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
        }
        
        @keyframes flash {
            from { opacity: 1; }
            to { opacity: 0.8; }
        }
        
        .locked-screen-message {
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            height: 100%;
            width: 100%;
            background: rgba(0, 0, 0, 0.9); 
            color: #FFD700; 
            font-size: 1.3em;
            font-weight: bold;
            padding: 20px;
            box-sizing: border-box; 
        }
        .locked-screen-message h3 {
             text-align: center; 
        }
        .locked-screen-message p {
            color: #eee; 
            font-size: 1em; 
            margin-top: 15px; 
            text-align: center; 
            max-width: 90%; 
        }


        .forest-content {
            position: relative;
            display: flex;
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            height: 100%;
            
            /* --- –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–∫–ª—é—á–∞–µ–º –ú—É–ª—å—Ç–∏—Ç–∞—á --- */
            touch-action: manipulation; 
            /* -------------------------------------------------- */
        }

        .forest-screen .squirrel-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            transition: transform 0.05s ease;
            position: relative;
            z-index: 10;
            /* --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º —Å–∏–Ω—é—é –æ–±–≤–æ–¥–∫—É –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ/–∫–ª–∏–∫–µ --- */
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            /* ----------------------------------------------------- */
        }
        
        @keyframes clickShake {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .forest-screen .squirrel-btn:active {
            animation: clickShake 0.15s ease-out; 
            transform: scale(0.98); 
        }

        .forest-screen .squirrel-btn img {
            width: 100%; 
            max-width: 400px; 
            height: auto; 
            position: relative;
            top: 20px; 
            pointer-events: none;
        }
        
        .forest-screen h3 {
            display: none; 
        }

        .tap-animation {
            position: absolute;
            top: 50%; 
            left: 50%;
            font-size: 2em;
            font-weight: 900;
            color: gold;
            text-shadow: 1px 1px 3px black;
            pointer-events: none;
            opacity: 0;
            animation: floatUp 1s ease-out forwards;
            z-index: 20;
        }

        @keyframes floatUp {
            0% { opacity: 0; transform: translate(-50%, 0); }
            15% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -150px); }
        }
        
        @keyframes floatUpCrit {
            0% { opacity: 0; transform: translate(-50%, 0) scale(1); }
            15% { opacity: 1; transform: translate(-52%, -5px) scale(1.2) rotate(-5deg); }
            30% { opacity: 1; transform: translate(-48%, -10px) scale(1.2) rotate(5deg); }
            100% { opacity: 0; transform: translate(-50%, -150px) scale(1.2) rotate(0deg); }
        }
        
        .tap-animation.critical {
            font-size: 3em; 
            color: #FFA500; 
            text-shadow: 0 0 5px black, 0 0 10px #FFD700;
            animation: floatUpCrit 1s ease-out forwards; 
        }


        .game-screen-scroll {
             padding: 20px;
             overflow-y: auto;
             height: 100%;
        }
        .upgrade-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-bottom: 50px;
        }
        .upgrade-item {
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .upgrade-item img {
            width: 48px;
            height: 48px;
            margin-right: 15px;
            background: #444; 
            border-radius: 8px;
        }
        
        .upgrade-info {
            flex-grow: 1;
            text-align: left;
        }
        .upgrade-info strong {
            margin-bottom: 4px; 
            display: inline-block;
        }
        .upgrade-info .level-text {
            font-size: 0.9em;
            color: #aaa; 
            margin-bottom: 4px; 
        }
        .upgrade-info .description-line {
            font-size: 0.9em;
            color: #eee; 
            font-weight: 500;
            line-height: 1.3;
        }
        .upgrade-info .description-line-next {
            color: #4CAF50; 
            font-weight: bold;
        }
        
        .buy-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            transition: background-color 0.3s;
        }
        .buy-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            animation: none; 
        }
        .buy-btn.purchased { 
            background-color: #3F51B5; 
        }
        .buy-btn.max-level {
            background-color: #CC0000;
            cursor: not-allowed;
        }
        
        .raid-content { display: flex; flex-direction: column; align-items: center; text-align: center; padding-top: 20px; }
        .raid-btn { background-color: #E53935; color: white; border: none; padding: 20px 30px; border-radius: 12px; font-size: 1.2em; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .raid-log { margin-top: 30px; text-align: left; font-size: 0.9em; color: #ccc; width: 100%; padding: 0 20px; box-sizing: border-box; }
        .raid-battle-container { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box; }
        .defender-info { margin-bottom: 20px; }
        .raid-hp-bar { width: 100%; max-width: 300px; height: 20px; background-color: rgba(255, 255, 255, 0.2); border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        .raid-hp-fill { height: 100%; background: linear-gradient(90deg, #E53935, #FFB300); transition: width 0.1s linear; }
        .raid-duplo-btn { background: none; border: none; padding: 0; cursor: pointer; transition: transform 0.05s ease; }
        .raid-duplo-btn img { width: 200px; height: auto; }
        .raid-result { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 30px; background: rgba(0, 0, 0, 0.8); border-radius: 15px; z-index: 100; text-align: center; }
        .energy-bar-container { padding: 10px 15px; flex-shrink: 0; background: rgba(0, 0, 0, 0.3); }
        .energy-bar-label { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px; }
        .energy-bar-fill { width: 100%; height: 10px; background-color: rgba(255, 255, 255, 0.2); border-radius: 5px; overflow: hidden; }
        .energy-bar-inner { height: 100%; background: linear-gradient(90deg, #64DD17, #33B760); border-radius: 5px; transition: width 0.5s ease; }
        .tab-bar { display: flex; justify-content: space-around; background: rgba(0, 0, 0, 0.9); border-top: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; padding: 0 0 5px 0; }
        .tab-item { flex-grow: 1; padding: 5px 0 5px 0; text-align: center; cursor: pointer; color: #eee; border-top: 3px solid transparent; transition: color 0.2s, border-color 0.2s, transform 0.1s; font-size: 1em; font-weight: 500; }
        .tab-item:active { transform: scale(0.98); }
        .tab-item img { width: 32px; height: 32px; opacity: 0.9; margin-bottom: 2px; display: block; margin: 0 auto 2px auto; }
        .tab-item.active { color: #eee; border-top-color: #FFD700; }
        .tab-item.active img { opacity: 1; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .app-modal { background: #282828; padding: 30px; border-radius: 15px; max-width: 300px; width: 90%; text-align: center; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); border: 2px solid gold; animation: fadeIn 0.3s ease-out; box-sizing: border-box; }
        .app-modal h3 { font-size: 1.5em; margin-top: 0; margin-bottom: 15px; font-weight: bold; }
        .app-modal h3.success { color: #4CAF50; }
        .app-modal h3.max-level { color: #FFD700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.8); }
        .app-modal h3.ended { color: #FF7043; }
        .app-modal p { color: white; font-size: 1.1em; margin-bottom: 20px; line-height: 1.4; }
        .app-modal .icon { font-size: 3em; margin-bottom: 15px; display: inline-block; }
        .app-modal .bot-icon { animation: pulse 1.5s infinite alternate; }
        .app-modal .level-icon { color: gold; text-shadow: 0 0 10px rgba(255, 215, 0, 0.8); }
        .app-modal .buy-btn { background-color: #4CAF50; color: white; font-weight: bold; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); } 70% { box-shadow: 0 0 10px 10px rgba(76, 175, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); } }
        
        /* –°–¢–ò–õ–ò –î–õ–Ø –ö–ù–û–ü–û–ö –ù–ê –û–°–ù–û–í–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (Task, Daily) */
        .tasks-button, .daily-rewards-button { 
            position: absolute; 
            width: 65px; /* –†–∞–∑–º–µ—Ä 65px */
            height: 65px; /* –†–∞–∑–º–µ—Ä 65px */
            background: none; border: none; border-radius: 0; 
            display: flex; 
            justify-content: center; align-items: center; 
            cursor: pointer; z-index: 40; 
            padding: 0; 
            color: transparent; 
            text-shadow: none; 
        }
        
        /* –°–¢–ò–õ–¨ –¢–û–õ–¨–ö–û –î–õ–Ø –ö–ù–û–ü–ö–ò –ù–ê–°–¢–†–û–ï–ö (–£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä) */
        .settings-button { 
            position: absolute; 
            width: 55px; /* –£–ú–ï–ù–¨–®–ï–ù–û –¥–ª—è Settings */
            height: 55px; /* –£–ú–ï–ù–¨–®–ï–ù–û –¥–ª—è Settings */
            background: none; border: none; border-radius: 0; 
            display: flex; 
            justify-content: center; align-items: center; 
            cursor: pointer; z-index: 40; 
            padding: 0; 
            color: transparent; 
            text-shadow: none; 
        }

        .tasks-button { top: 20px; right: 20px; }
        .daily-rewards-button { top: 95px; right: 20px; }
        .settings-button { top: 20px; left: 20px; right: auto; }

        .tasks-button img, .daily-rewards-button img, .settings-button img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.2s;
        }

        .settings-button:active img, .daily-rewards-button:active img, .tasks-button:active img { 
            transform: scale(0.95); 
        }
         
        .notification-badge { position: absolute; top: 0px; right: 0px; background: red; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.6em; font-weight: bold; }
        .daily-rewards-button .notification-badge { top: 5px; right: 5px; }
        .tasks-modal { background: #282828; padding: 15px 20px 20px 20px; border-radius: 15px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); border: 2px solid gold; animation: fadeIn 0.3s ease-out; box-sizing: border-box; max-height: 70vh; }
        .tasks-modal h2 { color: gold; margin-top: 0; display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 15px; }
        .task-tab-bar { display: flex; justify-content: space-around; border-bottom: 1px solid #555; margin-bottom: 15px; }
        .task-tab { flex-grow: 1; padding: 10px 5px; cursor: pointer; color: #aaa; font-weight: 500; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; position: relative; }
        .task-tab:hover { color: #eee; }
        .task-tab.active { color: gold; border-bottom-color: gold; }
        .task-tab-badge { position: absolute; top: 5px; right: 5px; background: red; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.7em; font-weight: bold; line-height: 18px; }
        .task-list-content { max-height: calc(70vh - 150px); overflow-y: auto; &::-webkit-scrollbar { width: 6px; } &::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; } &::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); } }
        .task-item { display: flex; align-items: center; background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.1); transition: background 0.3s, border-color 0.3s; }
        .task-item.is-claimable { background: rgba(76, 175, 80, 0.15); border-color: #4CAF50; }
        .task-item.is-claimable .buy-btn { background-color: #4CAF50; animation: pulse-green 1.5s infinite; }
        .task-item .icon { font-size: 2em; margin-right: 15px; }
        .task-info { flex-grow: 1; text-align: left; }
        .task-title-row { display: flex; align-items: center; gap: 8px; }
        .task-info-btn { background: #555; color: white; border: 1px solid #777; border-radius: 50%; width: 20px; height: 20px; font-size: 0.8em; font-weight: bold; padding: 0; cursor: pointer; line-height: 18px; flex-shrink: 0; }
        .task-info strong { font-size: 1.1em; }
        .task-info .progress-text { font-size: 0.9em; color: #aaa; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background: #4CAF50; border-radius: 4px; transition: width 0.3s; }
        .daily-rewards-modal { background: #282828; padding: 20px; border-radius: 15px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); border: 2px solid gold; animation: fadeIn 0.3s ease-out; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
         .daily-rewards-modal h2 { color: gold; margin-top: 0; margin-bottom: 20px; }
        .daily-rewards-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .daily-reward-item { background: rgba(0, 0, 0, 0.3); border: 2px solid #555; border-radius: 10px; padding: 15px 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100px; box-sizing: border-box; }
        .daily-reward-item .day-label { font-size: 0.9em; font-weight: bold; color: #aaa; margin-bottom: 10px; }
        .daily-reward-item .reward-icon { font-size: 2em; margin-bottom: 10px; }
        .daily-reward-item .reward-label { font-size: 1em; font-weight: bold; }
        .daily-reward-item.day-7 { grid-column: span 3; background: linear-gradient(145deg, rgba(0, 0, 0, 0.3), rgba(255, 215, 0, 0.1)); border-color: #777; }
        .daily-reward-item.locked { background: rgba(0, 0, 0, 0.6); border-color: #444; color: #777; cursor: pointer; }
         .daily-reward-item.locked .reward-icon { font-size: 2.5em; }
        .daily-reward-item.claimed { background: rgba(0, 0, 0, 0.1); border-color: #4CAF50; opacity: 0.6; }
        .daily-reward-item.claimed .reward-icon { font-size: 2.5em; color: #4CAF50; }
        .daily-reward-item.available { background: rgba(76, 175, 80, 0.15); border-color: #4CAF50; color: #fff; cursor: pointer; animation: pulse-green 1.5s infinite; transition: transform 0.2s ease; }
        .daily-reward-item.available:hover { transform: scale(1.05); }
        .settings-modal { background: #282828; padding: 20px; border-radius: 15px; max-width: 400px; width: 90%; text-align: left; box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); border: 2px solid gold; animation: fadeIn 0.3s ease-out; box-sizing: border-box; max-height: 90vh; overflow-y: auto; }
        .settings-modal h2 { color: gold; margin-top: 0; margin-bottom: 25px; text-align: center; }
        .settings-section { margin-bottom: 20px; }
        .settings-section h3 { margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .settings-section p { font-size: 0.95em; color: #ccc; line-height: 1.5; margin: 0; }
        .settings-toggle-row { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; font-weight: bold; padding: 10px 0; }
        .settings-toggle-row input[type="range"] { flex-grow: 1; margin-left: 15px; margin-right: 10px; cursor: pointer; }
        .settings-toggle-row span { min-width: 45px; text-align: right; font-variant-numeric: tabular-nums; }
        .settings-button-link { display: block; background-color: #007BFF; color: white !important; text-decoration: none; padding: 12px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; transition: background-color 0.2s; margin-top: 10px; border: none; width: 100%; box-sizing: border-box; font-size: 1em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .settings-button-link:hover { background-color: #0056b3; }

    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        
        const { useState, useEffect, useRef } = React;

        let tapIdCounter = 0;
        
        // =================================================================
        // –§–ê–õ–¨–®–ò–í–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–• –ò –ö–û–ù–°–¢–ê–ù–¢–´
        // =================================================================
        
        const DAILY_REWARDS_CATALOG = [
            { day: 1, type: 'nut', value: 1000, icon: 'üí∞', label: '1 000 $NUT' },
            { day: 2, type: 'nut', value: 5000, icon: 'üí∞', label: '5 000 $NUT' },
            { day: 3, type: 'bonus', bonus: { type: 'madness', name: '–ë–µ–∑—É–º–∏–µ', multiplier: 10, duration: 10 }, icon: '‚ö°', label: 'x10 –ö–ª–∏–∫ (10—Å)' },
            { day: 4, type: 'nut', value: 25000, icon: 'üí∞', label: '25 000 $NUT' },
            { day: 5, type: 'bonus', bonus: { type: 'speed', name: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ', rate: 15, duration: 15 }, icon: '‚ö°', label: '+15 ‚ö°Ô∏è/—Å–µ–∫ (15—Å)' },
            { day: 6, type: 'nut', value: 50000, icon: 'üí∞', label: '50 000 $NUT' },
            { day: 7, type: 'nut', value: 100000, icon: 'üéâ', label: '100 000 $NUT' },
        ];
        
        const SAVE_DATA_KEY = 'squirrelWarsSaveData';
        
        const audioTap = new Audio('audio/click.mp3');
        audioTap.volume = 0.2; 
        
        const playSound = (audioElement) => {
            if (!audioElement) return; 
            audioElement.currentTime = 0;
            audioElement.play().catch(e => console.log("")); 
        };
        
        const RAID_ENERGY_COST = 250;
        const RAID_DURATION_SECONDS = 30;
        const GOLDEN_NUT_INTERVAL_S = 600; 
        const GOLDEN_NUT_DURATION_S = 10; 
        const NUT_SIZE = 75; 
        
        const BASE_BOT_RATE = 10; 
        
        const MAX_LEVEL_TAP = 100;
        const MAX_LEVEL_ENERGY_LIMIT = 20;
        const MAX_LEVEL_ENERGY_RECHARGE = 20;
        const BASE_ENERGY = 1000;
        const ENERGY_LIMIT_PER_LEVEL = 250;
        const ENERGY_RECHARGE_PER_LEVEL = 0.2;
        
        // --- –ü–ï–†–ï–ù–û–° –†–ê–°–ß–ï–¢–ê –ë–û–ù–£–°–û–í –í–ù–ï useEffect –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö ---
        
        const calculateStats = (levels, permBonusLimit) => {
             const baseTap = (1 + levels.multitap * 1 + 0); // permBonusClick –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∑–¥–µ—Å—å
             const maxEnergy = BASE_ENERGY + levels.energyLimit * ENERGY_LIMIT_PER_LEVEL + permBonusLimit;
             const rechargeRate = (1 + levels.energyRecharge * ENERGY_RECHARGE_PER_LEVEL) + 0 + 0; // rechargeBonus, permBonusRecharge –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –∑–¥–µ—Å—å
             
             return { maxEnergy, rechargeRate, baseTap };
        };
        
        // ----------------------------------------------------------------------------------------

        const BOOST_CATALOG = {
            multitap: { id: 'multitap', name: '–ö—Ä–µ–ø–∫–∏–µ –ó—É–±—ã', description: `–î–æ–±—ã—á–∞ +1 $NUT –∑–∞ —Ç–∞–ø (–º–∞–∫—Å. ${MAX_LEVEL_TAP})`, baseCost: 500, icon: 'images/icon_multitap.png', type: 'level', maxLevel: MAX_LEVEL_TAP, emoji: 'ü¶∑' },
            energyLimit: { id: 'energyLimit', name: '–ó–∞–ø–∞—Å–ª–∏–≤–æ—Å—Ç—å', description: `–ú–∞–∫—Å. ‚ö°Ô∏è–≠–Ω–µ—Ä–≥–∏—è +${ENERGY_LIMIT_PER_LEVEL} (–º–∞–∫—Å. ${MAX_LEVEL_ENERGY_LIMIT})`, baseCost: 5000, icon: 'images/icon_energy_limit.png', type: 'level', maxLevel: MAX_LEVEL_ENERGY_LIMIT, emoji: 'üîã' },
            energyRecharge: { id: 'energyRecharge', name: '–®—É—Å—Ç—Ä—ã–µ –õ–∞–ø–∫–∏', description: `–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ +${ENERGY_RECHARGE_PER_LEVEL}/—Å–µ–∫ (–º–∞–∫—Å. ${MAX_LEVEL_ENERGY_RECHARGE})`, baseCost: 5000, icon: 'images/icon_energy_recharge.png', type: 'level', maxLevel: MAX_LEVEL_ENERGY_RECHARGE, emoji: '‚ö°' },
            autoBot: { id: 'autoBot', name: '–ë–µ–ª–∫–∞-–†–æ–±–æ—Ç', description: `–î–æ—Ö–æ–¥: +${BASE_BOT_RATE}/—Å–µ–∫. –û—Ñ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –±–æ–ª–µ–µ 2—á.`, baseCost: 1000000, icon: 'images/icon_autotap_bot.png', type: 'once', maxLevel: 1 }
        };


        const DEFENSE_CATALOG = {
            baseHp: { id: 'baseHp', name: '–£–∫—Ä–µ–ø–∏—Ç—å –°—Ç–µ–Ω–∫–∏', description: '–ü—Ä–æ—á–Ω–æ—Å—Ç—å –î—É–ø–ª–∞ +1000 HP', baseCost: 300, icon: 'images/icon_base_hp.png', type: 'level', emoji: 'üß±' },
            vault: { id: 'vault', name: '–£–≤–µ–ª–∏—á–∏—Ç—å –°–µ–π—Ñ', description: '–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –°–µ–π—Ñ–∞ +1000 $NUT', baseCost: 1000, icon: 'images/icon_vault.png', type: 'level', emoji: 'üí∞' }
        };
        
        const TASK_CATALOG = {
            'tap_chain': [
                { id: 'tap_1', name: '–ü–µ—Ä–≤—ã–π —Ö—Ä—É—Å—Ç', type: 'tap', target: 100, reward: 150, icon: 'üëÜ', details: '–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –±–µ–ª–∫—É 100 —Ä–∞–∑, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ—é –ø–µ—Ä–≤—É—é –Ω–∞–≥—Ä–∞–¥—É.' },
                { id: 'tap_2', name: '–ú–∞—Å—Ç–µ—Ä –∫–ª–∏–∫–∞', type: 'tap', target: 500, reward: 500, icon: 'üëÜ', details: '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç–∞–ø–∞—Ç—å! –î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 500 –∫–ª–∏–∫–æ–≤ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–∏–∑–∞.' },
                { id: 'tap_3', name: '–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –æ—Ä–µ—Ö–æ–≤', type: 'tap', target: 1000, reward: 1000, icon: 'üëÜ', details: '1000 –∫–ª–∏–∫–æ–≤ –ø–æ–∫–∞–∂—É—Ç, —á—Ç–æ –≤—ã —Å–µ—Ä—å–µ–∑–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.' },
                { id: 'tap_4', name: '–¢—É—Ä–±–æ-–ø–∞–ª–µ—Ü', type: 'tap', target: 5000, reward: 2000, icon: 'üëÜ', details: '5000 –∫–ª–∏–∫–æ–≤! –í–∞—à–∏ –ø–∞–ª—å—Ü—ã –µ—â–µ –Ω–µ —É—Å—Ç–∞–ª–∏?' },
                { id: 'tap_5', name: '–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü', type: 'tap', target: 10000, reward: 5000, icon: 'üëÜ', details: '10,000 –∫–ª–∏–∫–æ–≤. –í–ø–µ—á–∞—Ç–ª—è—é—â–∞—è –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å!' },
                { id: 'tap_6', name: '–ü–∞–ª–µ—Ü –≤ –æ–≥–Ω–µ', type: 'tap', target: 25000, reward: 10000, icon: 'üëÜ', details: '25,000 –∫–ª–∏–∫–æ–≤. –í—ã –≤ –æ–≥–Ω–µ!' },
                { id: 'tap_7', name: '–ú–∞—à–∏–Ω–∞ –¥–ª—è –∫–ª–∏–∫–æ–≤', type: 'tap', target: 50000, reward: 15000, icon: 'üëÜ', details: '50,000. –í—ã —É–∂–µ –ø–æ—á—Ç–∏ —Ä–æ–±–æ—Ç.' },
                { id: 'tap_8', name: '–©–µ–ª–∫—É–Ω—á–∏–∫', type: 'tap', target: 100000, reward: 25000, icon: 'üëÜ', details: '100,000 –∫–ª–∏–∫–æ–≤. –û—Ä–µ—Ö–∏ —Ç—Ä–µ—â–∞—Ç –æ—Ç —Å—Ç—Ä–∞—Ö–∞!' },
                { id: 'tap_9', name: '–¢–∞–ø-–Ω–∏–Ω–¥–∑—è', type: 'tap', target: 500000, reward: 50000, icon: 'üëÜ', details: '500,000. –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å.' },
                { id: 'tap_10', name: '–ë–æ–≥ –ö–ª–∏–∫–µ—Ä–æ–≤', type: 'tap', target: 1000000, reward: 100000, icon: 'üëÜ', details: '1,000,000 –∫–ª–∏–∫–æ–≤. –í—ã... –≤—ã –ø—Ä–æ—à–ª–∏ –∏–≥—Ä—É?' }
            ],
            'balance_chain': [
                { id: 'bal_1', name: '–ó–∞–∂–∏—Ç–æ—á–Ω–∞—è –±–µ–ª–∫–∞ (I)', type: 'balance', target: 1000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 15 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 1 000 $NUT.' },
                { id: 'bal_2', name: '–ó–∞–∂–∏—Ç–æ—á–Ω–∞—è –±–µ–ª–∫–∞ (II)', type: 'balance', target: 10000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 30 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 10 000 $NUT.' },
                { id: 'bal_3', name: '–ó–∞–∂–∏—Ç–æ—á–Ω–∞—è –±–µ–ª–∫–∞ (III)', type: 'balance', target: 100000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 45 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 100 000 $NUT.' },
                { id: 'bal_4', name: '–ë–µ–ª–∫–∞-–ö–∞–ø–∏—Ç–∞–ª–∏—Å—Ç (IV)', type: 'balance', target: 250000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 60 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 250 000 $NUT.' },
                { id: 'bal_5', name: '–ü–æ–ª–Ω—ã–π —Å–µ–π—Ñ (V)', type: 'balance', target: 500000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 60 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 500 000 $NUT.' },
                { id: 'bal_6', name: '–ë–µ–ª–∫–∞-–ú–∏–ª–ª–∏–æ–Ω–µ—Ä (VI)', type: 'balance', target: 1000000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 60 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 1 000 000 $NUT.' },
                { id: 'bal_7', name: '–ò–Ω–≤–µ—Å—Ç–æ—Ä (VII)', type: 'balance', target: 5000000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 60 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 5 000 000 $NUT.' },
                { id: 'bal_8', name: '–ú–∞–≥–Ω–∞—Ç (VIII)', type: 'balance', target: 10000000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 60 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 10 000 000 $NUT.' },
                { id: 'bal_9', name: '–û–ª–∏–≥–∞—Ä—Ö (IX)', type: 'balance', target: 50000000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 60 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 50 000 000 $NUT.' },
                { id: 'bal_10', name: '–ö–æ—Ä–æ–ª—å –ë–µ–ª–æ–∫ (X)', type: 'balance', target: 100000000, reward: { type: 'double_income', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', duration: 60 }, icon: 'üí∞', details: '–î–µ—Ä–∂–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –±–∞–ª–∞–Ω—Å–µ (–Ω–µ –≤ —Å–µ–π—Ñ–µ) 100 000 000 $NUT.' }
            ],
            'total_earned_chain': [
                { id: 'earn_1', name: '–ü–µ—Ä–≤—ã–µ –¥–µ–Ω—å–≥–∏', type: 'milestone', target: 1000, reward: { type: 'click', value: 1 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 1 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +1 –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞ (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_2', name: '–ü–æ–ª–Ω–∞—è –∫–æ–ø–∏–ª–∫–∞', type: 'milestone', target: 10000, reward: { type: 'click', value: 3 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 10 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +3 –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞ (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_3', name: '–°–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è –±–µ–ª–∫–∞', type: 'milestone', target: 100000, reward: { type: 'click', value: 5 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 100 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +5 –∫ —Å–∏–ª–µ –∫–ª–∏–∫–∞ (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_4', name: '–ü–µ—Ä–≤—ã–π –º–∏–ª–ª–∏–æ–Ω', type: 'milestone', target: 1000000, reward: { type: 'recharge', value: 1 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 1 000 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +1 ‚ö°Ô∏è/—Å–µ–∫ (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_5', name: '–ü–æ–ª–Ω—ã–π —Å–µ–π—Ñ', type: 'milestone', target: 10000000, reward: { type: 'limit', value: 500 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 10 000 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +500 ‚ö°Ô∏è –º–∞–∫—Å. (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_6', name: '–ú–∏–ª–ª–∏–æ–Ω–µ—Ä', type: 'milestone', target: 100000000, reward: { type: 'limit', value: 1000 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 100 000 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +1000 ‚ö°Ô∏è –º–∞–∫—Å. (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_7', name: '–ü–µ—Ä–≤—ã–π –º–∏–ª–ª–∏–∞—Ä–¥', type: 'milestone', target: 1000000000, reward: { type: 'limit', value: 1500 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 1 000 000 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +1500 ‚ö°Ô∏è –º–∞–∫—Å. (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_8', name: '–û—Ä–µ—Ö–æ–≤—ã–π –ú–∞–≥–Ω–∞—Ç', type: 'milestone', target: 10000000000, reward: { type: 'limit', value: 2000 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 10 000 000 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +2000 ‚ö°Ô∏è –º–∞–∫—Å. (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_9', name: '–ü–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–π –ë–∞–Ω–∫–∏—Ä', type: 'milestone', target: 100000000000, reward: { type: 'limit', value: 2500 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 100 000 000 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +2500 ‚ö°Ô∏è –º–∞–∫—Å. (–ù–∞–≤—Å–µ–≥–¥–∞).' },
                { id: 'earn_10', name: '–í–ª–∞–¥—ã–∫–∞ $NUT', type: 'milestone', target: 1000000000000, reward: { type: 'limit', value: 3000 }, icon: 'üìà', details: '–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 1 000 000 000 000 $NUT (–≤—Å–µ–≥–æ). –ù–∞–≥—Ä–∞–¥–∞: +3000 ‚ö°Ô∏è –º–∞–∫—Å. (–ù–∞–≤—Å–µ–≥–¥–∞).' }
            ]
        };
        
        const INITIAL_RAID_LOG = [
             { id: 1, type: 'win', amount: 0, target: '–ë–µ–ª–∫–∞_–í–∞—Å—è' },
        ];
        
        const INITIAL_FRIENDS_LIST = [
            { id: 101, name: '–ë–µ–ª–∫–∞_–î—Ä—É–≥1', contribution: 0 },
        ];

        // ===>>> –ò–°–ü–†–ê–í–õ–ï–ù–ê –§–£–ù–ö–¶–ò–Ø calculateCost <<<===
        const calculateCost = (baseCost, level, upgradeId) => {
            if (upgradeId === 'multitap') {
                if (level <= 40) {
                    return Math.floor(baseCost * Math.pow(1.5, level));
                } else if (level <= 60) {
                    const baseAt40 = baseCost * Math.pow(1.5, 40);
                    return Math.floor(baseAt40 * Math.pow(1.2, level - 40));
                } else if (level <= 80) {
                    const baseAt40 = baseCost * Math.pow(1.5, 40);
                    const baseAt60 = baseAt40 * Math.pow(1.2, 20); 
                    return Math.floor(baseAt60 * Math.pow(1.15, level - 60));
                } else if (level <= 100) {
                    const baseAt40 = baseCost * Math.pow(1.5, 40);
                    const baseAt60 = baseAt40 * Math.pow(1.2, 20);
                    const baseAt80 = baseAt60 * Math.pow(1.15, 20); 
                    return Math.floor(baseAt80 * Math.pow(1.1, level - 80));
                } else {
                    const baseAt40 = baseCost * Math.pow(1.5, 40);
                    const baseAt60 = baseAt40 * Math.pow(1.2, 20);
                    const baseAt80 = baseAt60 * Math.pow(1.15, 20);
                    const baseAt100 = baseAt80 * Math.pow(1.1, 20); 
                    return Math.floor(baseAt100); 
                }
            } else {
                return Math.floor(baseCost * Math.pow(1.5, level));
            }
        };


        const calculateBaseHp = (level) => {
            return 1000 + level * 1000;
        };

        const formatBalance = (num) => {
             if (num >= 1000000000) {
                return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + ' –º–ª—Ä–¥';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace(/\.0$/, '') + ' –º–ª–Ω';
            }
            if (num >= 10000) { 
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + ' K';
            }
            return num.toLocaleString('ru-RU');
        };
        
        const getMilestoneRewardText = (reward) => {
            if (reward.type === 'click') return `+${reward.value} –ö–ª–∏–∫`;
            if (reward.type === 'recharge') return `+${reward.value} ‚ö°Ô∏è/—Å–µ–∫`;
            if (reward.type === 'limit') return `+${reward.value} ‚ö°Ô∏è`;
            return '...';
        };
        
        const defaultLevels = {
            multitap: 0, 
            energyLimit: 0, 
            energyRecharge: 0, 
            autoBot: 0,
            baseHp: 2,
            vault: 1
        };
        const defaultTaskLevels = { tap_chain: 0, balance_chain: 0, total_earned_chain: 0 };
        const defaultDailyRewardsState = { currentDay: 0, lastClaimedTimestamp: null };


        // =================================================================
        // –ì–ª–∞–≤–Ω—ã–π –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ò–≥—Ä—ã (App)
        // =================================================================
        function App() {
            
            const [activeTab, setActiveTab] = useState('forest');
            const [balance, setBalance] = useState(0); 
            const [energy, setEnergy] = useState(BASE_ENERGY); 
            const [tapAnimations, setTapAnimations] = useState([]); 
            
            const [showBotModal, setShowBotModal] = useState(false);
            const [showUpgradeModal, setShowUpgradeModal] = useState(null); 
            const [showBonusModal, setShowBonusModal] = useState(null); 
            
            const [showGoldenNut, setShowGoldenNut] = useState(false);
            const [activeBonuses, setActiveBonuses] = useState([]); 
            const [nutPosition, setNutPosition] = useState({ x: 50, y: 50, isMovingUp: true }); 
            
            const [totalTaps, setTotalTaps] = useState(0); 
            const [totalEarned, setTotalEarned] = useState(0);
            const [taskLevels, setTaskLevels] = useState(defaultTaskLevels); 
            const [showTasksModal, setShowTasksModal] = useState(false);
            const [showTaskClaimModal, setShowTaskClaimModal] = useState(null);
            
            const [levels, setLevels] = useState(defaultLevels);
            
            const [dailyRewardsState, setDailyRewardsState] = useState(defaultDailyRewardsState); 
            const [isDailyRewardAvailable, setIsDailyRewardAvailable] = useState(false);
            const [showDailyRewardsModal, setShowDailyRewardsModal] = useState(false);
            
            const [showComeBackModal, setShowComeBackModal] = useState(false); 
            
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            
            const [musicVolume, setMusicVolume] = useState(50); 
            const [musicStarted, setMusicStarted] = useState(false);
            const audioMusicRef = useRef(new Audio('audio/music.mp3')); 
            
            const [offlineEarnings, setOfflineEarnings] = useState(0);
            const [showOfflineModal, setShowOfflineModal] = useState(false);
            
            const [raidStatus, setRaidStatus] = useState('idle'); 
            const [raidLog, setRaidLog] = useState(INITIAL_RAID_LOG);
            const [friendsList, setFriendsList] = useState(INITIAL_FRIENDS_LIST);
            
            
            // --- –†–ê–°–ß–ï–¢–´ –ë–û–ù–£–°–û–í ---
            let tapMultiplier = 1;
            let doubleIncomeMultiplier = 1;
            let rechargeBonus = 0; 
            let permBonusClick = 0;
            let permBonusRecharge = 0;
            let permBonusLimit = 0;
            
            const completedMilestones = TASK_CATALOG.total_earned_chain.slice(0, taskLevels.total_earned_chain);
            completedMilestones.forEach(task => {
                if (task.reward.type === 'click') permBonusClick += task.reward.value;
                if (task.reward.type === 'recharge') permBonusRecharge += task.reward.value;
                if (task.reward.type === 'limit') permBonusLimit += task.reward.value;
            });
            
            activeBonuses.forEach(bonus => {
                if (bonus.type === 'madness') tapMultiplier = bonus.multiplier;
                else if (bonus.type === 'speed') rechargeBonus = bonus.rate;
                else if (bonus.type === 'double_income') doubleIncomeMultiplier = 2;
            });
            
            const baseTap = (1 + levels.multitap * 1 + permBonusClick);
            const tapValue = Math.floor((baseTap) * tapMultiplier * doubleIncomeMultiplier); 
            const maxEnergy = BASE_ENERGY + levels.energyLimit * ENERGY_LIMIT_PER_LEVEL + permBonusLimit;
            const rechargeRate = (1 + levels.energyRecharge * ENERGY_RECHARGE_PER_LEVEL) + rechargeBonus + permBonusRecharge; 
            const passiveRatePerSec = levels.autoBot > 0 ? BASE_BOT_RATE : 0; 

            const currentTapTask = TASK_CATALOG.tap_chain[taskLevels.tap_chain];
            const currentBalanceTask = TASK_CATALOG.balance_chain[taskLevels.balance_chain];
            const currentEarnedTask = TASK_CATALOG.total_earned_chain[taskLevels.total_earned_chain];
            
            const completedTapTasks = (currentTapTask && totalTaps >= currentTapTask.target) ? 1 : 0;
            const completedBalanceTasks = (currentBalanceTask && balance >= currentBalanceTask.target) ? 1 : 0;
            const completedMilestoneTasks = (currentEarnedTask && totalEarned >= currentEarnedTask.target) ? 1 : 0;
            
            const completedTaskCount = completedTapTasks + completedBalanceTasks + completedMilestoneTasks;
            
            
            useEffect(() => {
                const data = localStorage.getItem(SAVE_DATA_KEY);
                let savedData = null;
                
                // 1. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                if (data) {
                    try {
                        savedData = JSON.parse(data);
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∏–∑ localStorage", e);
                        localStorage.removeItem(SAVE_DATA_KEY); 
                    }
                }
                
                // --- –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –£–°–¢–†–ê–ù–ï–ù–ò–ï –û–®–ò–ë–ö–ò –ß–ï–†–ù–û–ì–û –≠–ö–†–ê–ù–ê ---
                let initialLevels = savedData ? savedData.levels || defaultLevels : defaultLevels;
                let initialTaskLevels = savedData ? savedData.taskLevels || defaultTaskLevels : defaultTaskLevels;
                
                // 2. –†–∞—Å—á–µ—Ç –ø–µ—Ä–º–∞–Ω–µ–Ω—Ç–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
                let tempPermBonusLimit = 0;
                let tempPermBonusRecharge = 0;
                
                // –ó–∞—â–∏—Ç–∞ –æ—Ç undefined: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –º–∞—Å—Å–∏–≤–µ, –ø—Ä–µ–∂–¥–µ —á–µ–º –µ–≥–æ slice'–∏—Ç—å
                if (initialTaskLevels.total_earned_chain !== undefined) {
                    const completedM = TASK_CATALOG.total_earned_chain.slice(0, initialTaskLevels.total_earned_chain);
                    completedM.forEach(task => {
                        if (task.reward.type === 'recharge') tempPermBonusRecharge += task.reward.value;
                        if (task.reward.type === 'limit') tempPermBonusLimit += task.reward.value;
                    });
                }


                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é –∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º loaded levels
                const calculatedMaxEnergy = BASE_ENERGY + initialLevels.energyLimit * ENERGY_LIMIT_PER_LEVEL + tempPermBonusLimit;
                const calculatedRechargeRate = (1 + initialLevels.energyRecharge * ENERGY_RECHARGE_PER_LEVEL) + tempPermBonusRecharge; 

                // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≠–Ω–µ—Ä–≥–∏–∏ –∏ –û—Ñ–ª–∞–π–Ω-–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
                let loadedEnergy = BASE_ENERGY; // –î–µ—Ñ–æ–ª—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
                
                if (savedData) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º savedData.energy, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å, –ò–ù–ê–ß–ï 0.
                    // –≠–¢–û –†–ï–®–ê–ï–¢ –ü–†–û–ë–õ–ï–ú–£ –°–ö–ê–ß–ö–ê –î–û 1000, —Ç.–∫. –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –∏–≥—Ä–∞–ª, savedEnergy –±—É–¥–µ—Ç 
                    // –ª–∏–±–æ —Ç–µ–∫—É—â–∏–º, –ª–∏–±–æ 0. –ï—Å–ª–∏ –æ–Ω –Ω–æ–≤—ã–π, —Ç–æ initial Energy –±—É–¥–µ—Ç BASE_ENERGY (1000).
                    const savedEnergy = savedData.energy !== undefined ? savedData.energy : 0; 
                    const lastOnlineTimestamp = savedData.lastOnlineTimestamp || Date.now();
                    const timeDiffSeconds = Math.floor((Date.now() - lastOnlineTimestamp) / 1000);
                    
                    if (timeDiffSeconds > 0) {
                        const regeneratedEnergy = timeDiffSeconds * calculatedRechargeRate;
                        // –†–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–Ω–µ—Ä–≥–∏—é, –Ω–æ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç
                        loadedEnergy = Math.min(savedEnergy + regeneratedEnergy, calculatedMaxEnergy);
                    } else {
                        loadedEnergy = savedEnergy;
                    }
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    setBalance(savedData.balance || 0);
                    setDailyRewardsState(savedData.dailyRewardsState || defaultDailyRewardsState);
                    setTotalTaps(savedData.totalTaps || 0);
                    setTotalEarned(savedData.totalEarned || 0);
                    setMusicVolume(savedData.musicVolume !== undefined ? savedData.musicVolume : 50);

                    // –†–∞—Å—á–µ—Ç –æ—Ñ–ª–∞–π–Ω-–¥–æ—Ö–æ–¥–∞ –æ—Ç –†–æ–±–æ—Ç–∞ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                    if (initialLevels.autoBot > 0) {
                        const maxOfflineTime = 7200; 
                        const effectiveTime = Math.min(timeDiffSeconds, maxOfflineTime);
                        const earnings = Math.floor(effectiveTime * BASE_BOT_RATE);

                        if (earnings > 0) {
                            setOfflineEarnings(earnings); 
                            setShowOfflineModal(true);  
                        }
                    }
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                setLevels(initialLevels);
                setTaskLevels(initialTaskLevels);
                setEnergy(loadedEnergy); 

                const savedTimestamp = (savedData && savedData.dailyRewardsState) ? savedData.dailyRewardsState.lastClaimedTimestamp : null;
                const today = new Date().toDateString(); 
                const lastClaimedDate = savedTimestamp ? new Date(savedTimestamp).toDateString() : null;
                
                if (today !== lastClaimedDate) {
                    setIsDailyRewardAvailable(true); 
                }
                
                setIsDataLoaded(true); 
            }, []); 
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç energy, –∫–æ—Ç–æ—Ä—É—é –º—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏/—Ä–∞—Å—Å—á–∏—Ç–∞–ª–∏)
            useEffect(() => {
                if (isDataLoaded) { 
                    const dataToSave = {
                        balance,
                        energy, 
                        levels,
                        taskLevels,
                        dailyRewardsState,
                        totalTaps,
                        totalEarned,
                        musicVolume, 
                        lastOnlineTimestamp: Date.now() 
                    };
                    localStorage.setItem(SAVE_DATA_KEY, JSON.stringify(dataToSave));
                }
            }, [balance, energy, levels, taskLevels, dailyRewardsState, totalTaps, totalEarned, isDataLoaded, musicVolume]);


            
            useEffect(() => {
                const timer = setInterval(() => {
                    setEnergy(currentEnergy => 
                        Math.min(maxEnergy, currentEnergy + rechargeRate)
                    );
                    
                    if (passiveRatePerSec > 0) {
                        const income = passiveRatePerSec; 
                        setBalance(currentBalance => currentBalance + income);
                        setTotalEarned(t => t + income); 

                        const newTap = {
                            id: tapIdCounter++,
                            value: `+${income} (Bot)`,
                            x: 250, 
                            y: 250,
                            color: 'lightblue',
                            isPassive: true
                        };
                        setTapAnimations(prev => [...prev, newTap]);

                        setTimeout(() => {
                            setTapAnimations(prev => prev.filter(tap => tap.id !== newTap.id));
                        }, 1000);
                    }
                    
                }, 1000);
                
                return () => clearInterval(timer);
            }, [maxEnergy, rechargeRate, passiveRatePerSec]); 
            
            useEffect(() => {
                const MAX_X = 90; 
                const MIN_X = 5;
                const MIN_Y = 15; 
                const MAX_Y = 85; 
                
                let nutTimeoutId; 
                
                const generateInitialPosition = () => {
                    const startX = Math.floor(Math.random() * (MAX_X - MIN_X) + MIN_X);
                    const startY = Math.floor(Math.random() * (MAX_Y - MIN_Y) + MIN_Y);
                    
                    return { x: startX, y: startY, isMovingUp: Math.random() > 0.5 };
                };
                
                const showNut = () => {
                     setNutPosition(generateInitialPosition());
                     setShowGoldenNut(true);
                     
                     nutTimeoutId = setTimeout(() => {
                         setShowGoldenNut(false);
                     }, GOLDEN_NUT_DURATION_S * 1000); 
                };
                
                const initialTimeout = setTimeout(showNut, 10000); 
                const intervalId = setInterval(showNut, GOLDEN_NUT_INTERVAL_S * 1000); 
                
                return () => {
                    clearTimeout(initialTimeout);
                    clearInterval(intervalId);
                    clearTimeout(nutTimeoutId);
                };
            }, [showGoldenNut]); 

            useEffect(() => {
                let nutMoveIntervalId;
                
                if (showGoldenNut) {
                    const MAX_X = 90; 
                    const MIN_X = 5;
                    const MIN_Y = 15; 
                    const MAX_Y = 85; 
                    const Y_SPEED = 5; 
                    const X_DRIFT = 10; 

                    const moveNut = () => {
                        setNutPosition(prevPos => {
                            let newY = prevPos.y;
                            let newX = prevPos.x;
                            let isMovingUp = prevPos.isMovingUp;

                            if (isMovingUp) {
                                newY -= Y_SPEED;
                                if (newY <= MIN_Y) { 
                                    newY = MIN_Y;
                                    isMovingUp = false; 
                                }
                            } else {
                                newY += Y_SPEED;
                                if (newY >= MAX_Y) { 
                                    newY = MAX_Y;
                                    isMovingUp = true; 
                                }
                            }
                            
                            newX += (Math.random() * X_DRIFT * 2) - X_DRIFT; 
                            newX = Math.max(MIN_X, Math.min(MAX_X, newX));

                            return { x: newX, y: newY, isMovingUp: isMovingUp };
                        });
                    };
                    
                    nutMoveIntervalId = setInterval(moveNut, 1000);
                }

                return () => {
                    clearInterval(nutMoveIntervalId); 
                };
            }, [showGoldenNut]); 
            
            useEffect(() => {
                audioMusicRef.current.loop = true;
                audioMusicRef.current.volume = musicVolume / 100;
                
                if (musicVolume > 0 && musicStarted) {
                    audioMusicRef.current.play().catch(e => console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏:", e));
                } else {
                    audioMusicRef.current.pause();
                }
            }, [musicVolume, musicStarted]);
            
            
            const handleGoldenNutClick = (e) => {
                 e.stopPropagation(); 

                 if (!showGoldenNut) return;
                 setShowGoldenNut(false);
                 
                 const bonuses = [
                     { type: 'instant', name: '–û—Ä–µ—Ö–æ–ø–∞–¥', value: 1000, duration: 0 },
                     { type: 'madness', name: '–ë–µ–∑—É–º–∏–µ', multiplier: 10, duration: 10 },
                     { type: 'speed', name: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ', rate: 15, duration: 10 },
                 ];
                 
                 const chosenBonus = bonuses[Math.floor(Math.random() * bonuses.length)];

                 if (chosenBonus.type === 'instant') {
                     setBalance(b => b + chosenBonus.value);
                     setTotalEarned(t => t + chosenBonus.value); 
                     setShowBonusModal({ 
                         icon: 'üéâ', 
                         title: chosenBonus.name, 
                         message: `–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${chosenBonus.value} $NUT!`, 
                         button: '–ó–∞–±—Ä–∞—Ç—å' 
                     });
                 } else {
                     setActiveBonuses(prev => [...prev, chosenBonus]);
                     
                     let message = '';
                     if (chosenBonus.type === 'madness') {
                         message = `–í–∞—à –∫–ª–∏–∫ –≤ ${chosenBonus.multiplier} —Ä–∞–∑ —Å–∏–ª—å–Ω–µ–µ –Ω–∞ ${chosenBonus.duration} —Å–µ–∫—É–Ω–¥!`;
                     } else if (chosenBonus.type === 'speed') {
                         message = `–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏ +${chosenBonus.rate}/—Å–µ–∫ –Ω–∞ ${chosenBonus.duration} —Å–µ–∫—É–Ω–¥!`;
                     }
                     
                     setShowBonusModal({ 
                         icon: '‚ö°', 
                         title: chosenBonus.name, 
                         message: message, 
                         button: '–û—Ç–ª–∏—á–Ω–æ!' 
                     });
                     
                     setTimeout(() => {
                         setActiveBonuses(prev => prev.filter(b => b.name !== chosenBonus.name));
                         setShowBonusModal({
                             icon: 'üï∞Ô∏è',
                             title: '–ë–æ–Ω—É—Å –ó–∞–≤–µ—Ä—à–∏–ª—Å—è',
                             message: `–î–µ–π—Å—Ç–≤–∏–µ –±–æ–Ω—É—Å–∞ ¬´${chosenBonus.name}¬ª –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å.`, 
                             button: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'
                         });
                     }, chosenBonus.duration * 1000);
                 }
            };
            
            // --- –ù–û–í–´–ô –ï–î–ò–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –ö–õ–ò–ö–û–í –ò –¢–ê–ß–ï–ô ---
            const processTap = (tapCount, clientX, clientY, gameScreen) => {
                if (!musicStarted) {
                    if (musicVolume > 0) { 
                         audioMusicRef.current.play().catch(e => console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏:", e));
                    }
                    setMusicStarted(true);
                }
                
                if (activeTab !== 'forest' && activeTab !== 'raid') return; 

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤/—Ç–∞–ø–æ–≤
                const tapsToProcess = Math.min(tapCount, energy); 
                if (tapsToProcess <= 0) return;
                
                if (activeTab === 'raid' && raidStatus === 'battle') {
                     // –õ–æ–≥–∏–∫–∞ —Ä–µ–π–¥–æ–≤ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π
                     // handleRaidTap(tapsToProcess);
                     return;
                }
                
                if (activeTab === 'forest' && energy >= tapsToProcess) { 
                    setEnergy(e => e - tapsToProcess);
                    setTotalTaps(t => t + tapsToProcess);

                    let totalValue = 0;
                    const newAnimations = [];
                    const rect = gameScreen.getBoundingClientRect();
                    
                    for (let i = 0; i < tapsToProcess; i++) {
                        const isCritical = Math.random() < 0.01; 
                        const critMultiplier = 5;
                        const currentTapValue = isCritical ? (tapValue * critMultiplier) : tapValue;
                        totalValue += currentTapValue;
                        
                        // –°–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–ª–∏—Å—å
                        const animationX = clientX + (Math.random() * 20 - 10);
                        const animationY = clientY + (Math.random() * 20 - 10);

                        newAnimations.push({
                            id: tapIdCounter++,
                            value: `+${currentTapValue}`, 
                            x: animationX - rect.left,
                            y: animationY - rect.top,
                            isCritical: isCritical 
                        });
                    }

                    playSound(audioTap);
                    setBalance(b => b + totalValue);
                    setTotalEarned(t => t + totalValue);

                    setTapAnimations(prev => [...prev, ...newAnimations]);

                    // –£–¥–∞–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        setTapAnimations(prev => prev.filter(tap => !newAnimations.includes(tap)));
                    }, 1000);
                }
            };

            // 1. –î–ª—è –∫–ª–∏–∫–æ–≤ –º—ã—à—å—é (–Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ)
            const handleTap = (e) => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∑–æ–ª–æ—Ç–æ–π –æ—Ä–µ—Ö, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
                if (e.target.closest('.golden-nut-container')) {
                    handleGoldenNutClick(e); 
                    return;
                }
                
                const gameScreen = e.currentTarget.closest('.game-screen');
                processTap(1, e.clientX, e.clientY, gameScreen);
            };

            // 2. –î–ª—è —Ç–∞–ø–æ–≤ (–º—É–ª—å—Ç–∏—Ç–∞—á –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
            const handleTouchStart = (e) => {
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
                
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∑–æ–ª–æ—Ç–æ–π –æ—Ä–µ—Ö, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
                if (e.target.closest('.golden-nut-container')) {
                    handleGoldenNutClick(e); 
                    return;
                }
                
                const tapCount = e.touches.length; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–ª—å—Ü–µ–≤ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                const gameScreen = e.currentTarget.closest('.game-screen');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—Ä–≤–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏, –Ω–æ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ
                if (e.touches[0]) {
                    processTap(tapCount, e.touches[0].clientX, e.touches[0].clientY, gameScreen);
                }
            };
            // --- –ö–û–ù–ï–¶ –ï–î–ò–ù–û–ì–û –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê ---

            
            const handleBuyUpgrade = (catalog, upgradeId) => {
                const upgrade = catalog[upgradeId];
                const currentLevel = levels[upgradeId];
                
                const isMaxLevel = upgrade.type === 'level' && currentLevel >= upgrade.maxLevel;
                
                if (upgrade.type === 'once' && currentLevel > 0) {
                    alert('–≠—Ç–æ—Ç –±—É—Å—Ç —É–∂–µ –∫—É–ø–ª–µ–Ω!');
                    return;
                }
                
                if (isMaxLevel) {
                     setShowUpgradeModal({ id: upgradeId, level: currentLevel, isMax: true });
                     return;
                }

                const cost = upgrade.type === 'once' 
                    ? upgrade.baseCost 
                    : calculateCost(upgrade.baseCost, currentLevel, upgradeId);
                
                if (balance >= cost) {
                    setBalance(balance - cost);
                    setLevels(prevLevels => ({
                        ...prevLevels,
                        [upgradeId]: upgrade.type === 'once' ? 1 : prevLevels[upgradeId] + 1
                    }));

                    if (upgradeId === 'autoBot' && upgrade.type === 'once') {
                        setShowBotModal(true); 
                    } else if (upgrade.type === 'level') {
                         const newLevel = currentLevel + 1;
                         const reachedMax = newLevel === upgrade.maxLevel;
                         setShowUpgradeModal({ id: upgradeId, level: newLevel, isMax: reachedMax });
                    }
                    
                    if (upgradeId === 'energyLimit') {
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ª–∏–º–∏—Ç–∞
                        const oldMaxEnergy = BASE_ENERGY + currentLevel * ENERGY_LIMIT_PER_LEVEL + permBonusLimit;
                        const newMaxEnergy = BASE_ENERGY + (currentLevel + 1) * ENERGY_LIMIT_PER_LEVEL + permBonusLimit;
                        const energyRatio = energy / oldMaxEnergy;
                        setEnergy(Math.min(newMaxEnergy, Math.ceil(newMaxEnergy * energyRatio)));
                    }
                    
                } else {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ $NUT!');
                }
            };

            const handleVaultAction = (action, amount) => {
                // (–õ–æ–≥–∏–∫–∞ –°–µ–π—Ñ–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π, —Ç.–∫. –≤–∫–ª–∞–¥–∫–∞ 'home' –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞)
            };
            
            const handleClaimTask = (taskChainId) => {
                let task;
                if (taskChainId === 'tap_chain') {
                    task = TASK_CATALOG.tap_chain[taskLevels.tap_chain];
                    if (task && totalTaps >= task.target) {
                        setShowTaskClaimModal(task);
                        setShowTasksModal(false); 
                    }
                } else if (taskChainId === 'balance_chain') {
                    task = TASK_CATALOG.balance_chain[taskLevels.balance_chain];
                    if (task && balance >= task.target) {
                        setShowTaskClaimModal(task);
                        setShowTasksModal(false); 
                    }
                } else if (taskChainId === 'total_earned_chain') {
                    task = TASK_CATALOG.total_earned_chain[taskLevels.total_earned_chain];
                    if (task && totalEarned >= task.target) {
                        setShowTaskClaimModal(task);
                        setShowTasksModal(false); 
                    }
                }
            };
            
            const confirmClaimTask = (task) => {
                if (task.type === 'tap') {
                    setBalance(b => b + task.reward);
                    setTotalEarned(t => t + task.reward);
                    setTaskLevels(prev => ({
                        ...prev,
                        tap_chain: prev.tap_chain + 1
                    }));
                } else if (task.type === 'balance') {
                    const bonus = { ...task.reward, id: Date.now() };
                    setActiveBonuses(prev => [...prev, bonus]);
                    
                    setTimeout(() => {
                        setActiveBonuses(prev => prev.filter(b => b.id !== bonus.id));
                        setShowBonusModal({
                            icon: 'üï∞Ô∏è',
                            title: '–ë–æ–Ω—É—Å –ó–∞–≤–µ—Ä—à–∏–ª—Å—è',
                            message: `–î–µ–π—Å—Ç–≤–∏–µ –±–æ–Ω—É—Å–∞ ¬´${bonus.name}¬ª –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å.`,
                            button: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'
                        });
                    }, bonus.duration * 1000);
                    
                    setTaskLevels(prev => ({
                        ...prev,
                        balance_chain: prev.balance_chain + 1
                    }));
                } else if (task.type === 'milestone') {
                    setTaskLevels(prev => ({
                        ...prev,
                        total_earned_chain: prev.total_earned_chain + 1
                    }));
                }
                
                setShowTaskClaimModal(null); 
                setActiveTab('forest'); 
            };
            
            const handleClaimDailyReward = () => {
                if (!isDailyRewardAvailable) return;

                const reward = DAILY_REWARDS_CATALOG[dailyRewardsState.currentDay];
                
                if (reward.type === 'nut') {
                    setBalance(b => b + reward.value);
                    setTotalEarned(t => t + reward.value);
                } else if (reward.type === 'bonus') {
                    const bonus = { ...reward.bonus, id: Date.now() };
                    setActiveBonuses(prev => [...prev, bonus]);
                    setTimeout(() => {
                        setActiveBonuses(prev => prev.filter(b => b.id !== bonus.id));
                        setShowBonusModal({
                            icon: 'üï∞Ô∏è',
                            title: '–ë–æ–Ω—É—Å –ó–∞–≤–µ—Ä—à–∏–ª—Å—è',
                            message: `–î–µ–π—Å—Ç–≤–∏–µ –±–æ–Ω—É—Å–∞ ¬´${reward.bonus.name}¬ª –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å.`,
                            button: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'
                        });
                    }, reward.bonus.duration * 1000);
                }

                setDailyRewardsState({
                    currentDay: (dailyRewardsState.currentDay + 1) % 7, 
                    lastClaimedTimestamp: Date.now() 
                });
                setIsDailyRewardAvailable(false); 
                
                setShowDailyRewardsModal(false);
                setShowBonusModal({
                    icon: reward.icon,
                    title: '–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!',
                    message: `–í—ã –ø–æ–ª—É—á–∏–ª–∏: ${reward.label}!`,
                    button: '–û—Ç–ª–∏—á–Ω–æ!'
                });
            };

            
            const startRaid = () => { /* ... */ };
            const handleRaidTap = () => { /* ... */ };
            const finishRaid = (isWin) => { /* ... */ };
            const collectFriendBonus = () => { /* ... */ };
            

            // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–û—Ç—Ä–∏—Å–æ–≤–∫–∞) ---
            
            const renderActiveScreen = () => {
                if (!isDataLoaded) {
                    // –ü–æ–∫–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
                    return <div style={{flexGrow: 1, backgroundColor: '#1a1a1a'}}></div>; 
                }
                
                switch(activeTab) {
                    case 'forest':
                        return (
                            <div 
                                className="forest-content" 
                                onClick={handleTap} 
                                onTouchStart={handleTouchStart} 
                            >
                                <ForestScreen 
                                    onTasksClick={() => setShowTasksModal(true)} 
                                    completedTasks={completedTaskCount}
                                    onDailyRewardClick={() => setShowDailyRewardsModal(true)}
                                    isDailyRewardAvailable={isDailyRewardAvailable}
                                    onSettingsClick={() => setShowSettingsModal(true)}
                                />
                                
                                {activeBonuses.length > 0 && (
                                    <div className="active-bonus-indicator">
                                        {activeBonuses.map(bonus => (
                                            <div key={bonus.name} className="bonus-indicator-item">
                                                {/* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */}
                                                <span className="bonus-indicator-subtext">
                                                    ‚ö°Ô∏è {bonus.name} 
                                                    {bonus.type === 'madness' && <span> x{bonus.multiplier} –∫ –∫–ª–∏–∫—É!</span>}
                                                    {bonus.type === 'speed' && <span> +{bonus.rate} ‚ö°Ô∏è/—Å–µ–∫!</span>}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {showGoldenNut && (
                                    <div 
                                        className="golden-nut-container"
                                        onClick={handleGoldenNutClick}
                                        style={{ 
                                            top: `${nutPosition.y}%`,
                                            left: `${nutPosition.x}%`,
                                        }}
                                    >
                                        <img src="images/nut_golden_bonus.png" alt="Golden Nut" />
                                    </div>
                                )}

                                {tapAnimations.filter(t => t.color !== 'red' && !t.isPassive).map(tap => (
                                    <TapAnimation 
                                        key={tap.id} 
                                        value={tap.value} 
                                        x={tap.x} 
                                        y={tap.y} 
                                        isCritical={tap.isCritical}
                                    />
                                ))}
                                {tapAnimations.filter(t => t.isPassive).map(tap => (
                                    <TapAnimation 
                                        key={tap.id} 
                                        value={tap.value} 
                                        x={tap.x} 
                                        y={tap.y} 
                                        color={tap.color} 
                                    />
                                ))}
                            </div>
                        );
                    case 'boosts':
                        return (
                            <div className="game-screen-scroll">
                                <BoostsScreen 
                                    levels={levels} 
                                    balance={balance} 
                                    passiveRatePerSec={passiveRatePerSec}
                                    onBuy={(id) => handleBuyUpgrade(BOOST_CATALOG, id)}
                                    
                                    permBonusClick={permBonusClick}
                                    permBonusLimit={permBonusLimit}
                                    permBonusRecharge={permBonusRecharge}
                                />
                            </div>
                        );
                    case 'raid':
                    case 'home':
                    case 'squad':
                        return <LockedScreen tab={activeTab} />;
                    default:
                        return <div className="forest-content" onClick={handleTap} onTouchStart={handleTouchStart}><ForestScreen /></div>;
                }
            };
            
            return (
                <div className="app-container">
                    
                    <Header 
                        balance={balance} 
                        passiveRate={passiveRatePerSec} 
                    />
                    
                    <div className="game-screen">
                        {renderActiveScreen()}
                    </div>
                    
                    {showBotModal && <BotPurchaseModal onClose={() => setShowBotModal(false)} rate={BASE_BOT_RATE} />}
                    {showUpgradeModal && (
                        <UpgradeSuccessModal 
                            upgradeId={showUpgradeModal.id}
                            newLevel={showUpgradeModal.level}
                            isMax={showUpgradeModal.isMax}
                            onClose={() => setShowUpgradeModal(null)}
                        />
                    )}
                    {showBonusModal && (
                        <BonusNotificationModal 
                            details={showBonusModal}
                            onClose={() => setShowBonusModal(null)}
                        />
                    )}
                    {showTasksModal && (
                        <TasksModal 
                            onClose={() => setShowTasksModal(false)}
                            totalTaps={totalTaps}
                            balance={balance} 
                            totalEarned={totalEarned} 
                            taskLevels={taskLevels}
                            onClaim={handleClaimTask}
                            completedTapTasks={completedTapTasks}
                            completedBalanceTasks={completedBalanceTasks}
                            completedMilestoneTasks={completedMilestoneTasks}
                        />
                    )}
                    
                    {showTaskClaimModal && (
                        <TaskClaimModal
                            task={showTaskClaimModal}
                            onClaim={() => confirmClaimTask(showTaskClaimModal)}
                            onClose={() => setShowTaskClaimModal(null)}
                        />
                    )}
                    
                    {showDailyRewardsModal && (
                        <DailyRewardsModal
                            onClose={() => setShowDailyRewardsModal(false)}
                            rewardsCatalog={DAILY_REWARDS_CATALOG}
                            currentState={dailyRewardsState}
                            isAvailable={isDailyRewardAvailable}
                            onClaim={handleClaimDailyReward}
                            onShowComeBackModal={() => setShowComeBackModal(true)}
                        />
                    )}
                    
                    {showComeBackModal && (
                        <ComeBackTomorrowModal onClose={() => setShowComeBackModal(false)} />
                    )}
                    
                    {showSettingsModal && (
                        <SettingsModal
                            onClose={() => setShowSettingsModal(false)}
                            musicVolume={musicVolume}
                            onVolumeChange={setMusicVolume}
                        />
                    )}
                    
                    {showOfflineModal && (
                        <OfflineEarningsModal
                            earnings={offlineEarnings}
                            onClaim={() => {
                                setBalance(b => b + offlineEarnings);
                                setTotalEarned(t => t + offlineEarnings);
                                setShowOfflineModal(false);
                                setOfflineEarnings(0);
                            }}
                        />
                    )}


                    <EnergyBar energy={energy} maxEnergy={maxEnergy} />

                    <TabBar activeTab={activeTab} onTabClick={setActiveTab} />
                
                </div>
            );
        }


        // =================================================================
        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≠–∫—Ä–∞–Ω–æ–≤ –∏ UI-—ç–ª–µ–º–µ–Ω—Ç–æ–≤
        // =================================================================
        
        function OfflineEarningsModal({ earnings, onClaim }) {
            return (
                <div className="modal-overlay">
                    <div className="app-modal" onClick={(e) => e.stopPropagation()}>
                        <div className="icon bot-icon">ü§ñ</div>
                        <h3 className="success">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
                        <p>
                            –ü–æ–∫–∞ –≤–∞—Å –Ω–µ –±—ã–ª–æ, –≤–∞—à–∞ –ë–µ–ª–∫–∞-–†–æ–±–æ—Ç —Å–æ–±—Ä–∞–ª–∞:
                        </p>
                        <p style={{fontSize: '1.5em', fontWeight: 'bold', color: 'gold', margin: '10px 0 20px 0'}}>
                           + {formatBalance(earnings)} $NUT
                        </p>
                        <button className="buy-btn" onClick={onClaim}>
                            –ó–∞–±—Ä–∞—Ç—å!
                        </button>
                    </div>
                </div>
            );
        }

        
        function SettingsModal({ onClose, musicVolume, onVolumeChange }) { 
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="settings-modal" onClick={(e) => e.stopPropagation()}>
                        <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                        
                        <div className="settings-section">
                            <h3>–ó–≤—É–∫</h3>
                            <div className="settings-toggle-row">
                                <span>–ì—Ä–æ–º–∫–æ—Å—Ç—å –º—É–∑—ã–∫–∏</span>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    value={musicVolume} 
                                    onChange={(e) => onVolumeChange(Number(e.target.value))} 
                                />
                                <span>{musicVolume}%</span>
                            </div>
                        </div>

                        <div className="settings-section">
                            <h3>–û–± –∏–≥—Ä–µ</h3>
                            <p>
                                <strong>Squirrel Wars</strong> - —ç—Ç–æ –∫–ª–∏–∫–µ—Ä.
                            </p>
                        </div>
                        
                        <div className="settings-section">
                            <h3>–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</h3>
                            <a 
                                href="https://t.me/denzzzz_7" 
                                target="_blank" 
                                rel="noopener noreferrer" 
                                className="settings-button-link"
                                style={{backgroundColor: '#E53935'}}
                            >
                                üêû –°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ
                            </a>
                        </div>

                    </div>
                </div>
            );
        }

        
        function ComeBackTomorrowModal({ onClose }) {
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="app-modal" onClick={(e) => e.stopPropagation()}>
                        <div className="icon level-icon">üï∞Ô∏è</div>
                        <h3 className="max-level">–ù–∞–≥—Ä–∞–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
                        <p>
                            –í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –Ω–∞–≥—Ä–∞–¥—É.
                            –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞!
                        </p>
                        <button className="buy-btn" style={{backgroundColor: '#007BFF'}} onClick={onClose}>
                            –ü–æ–Ω—è—Ç–Ω–æ
                        </button>
                    </div>
                </div>
            );
        }

        
        function DailyRewardsModal({ onClose, rewardsCatalog, currentState, isAvailable, onClaim, onShowComeBackModal }) {
            
            const renderItem = (reward, index) => {
                const day = index + 1;
                let status = 'locked'; 
                let icon = 'üîí';
                
                if (index < currentState.currentDay) {
                    status = 'claimed';
                    icon = '‚úÖ';
                } else if (index === currentState.currentDay && isAvailable) {
                    status = 'available';
                    icon = reward.icon;
                } else {
                    icon = 'üîí';
                }
                
                const itemClass = `daily-reward-item ${status} day-${day}`;
                
                if (status === 'available') {
                    return (
                        <button key={day} className={itemClass} onClick={onClaim}>
                            <div className="day-label">–î–µ–Ω—å {day}</div>
                            <div className="reward-icon">{icon}</div>
                            <div className="reward-label">{reward.label}</div>
                        </button>
                    );
                }
                
                return (
                    <div 
                        key={day} 
                        className={itemClass}
                        onClick={status === 'locked' ? onShowComeBackModal : null} 
                        style={{ cursor: (status === 'locked') ? 'pointer' : 'default' }}
                    >
                        <div className="day-label">–î–µ–Ω—å {day}</div>
                        <div className="reward-icon">{icon}</div>
                        <div className="reward-label">
                            {status === 'claimed' ? reward.label : (status === 'locked' ? '???' : reward.label)}
                        </div>
                    </div>
                );
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="daily-rewards-modal" onClick={(e) => e.stopPropagation()}>
                        <h2>üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ù–∞–≥—Ä–∞–¥—ã</h2>
                        <div className="daily-rewards-grid">
                            {rewardsCatalog.map((reward, index) => renderItem(reward, index))}
                        </div>
                        
                        {!isAvailable && (
                            <div style={{marginTop: '20px', textAlign: 'center'}}>
                                <p style={{fontSize: '1.2em', color: 'gold', fontWeight: 'bold'}}>
                                    –°–ª–µ–¥—É—é—â–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –∑–∞–≤—Ç—Ä–∞!
                                </p>
                                <button 
                                    className="buy-btn" 
                                    style={{backgroundColor: '#007BFF', marginTop: '10px'}} 
                                    onClick={onClose}
                                >
                                    –ó–∞–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        
        function TaskClaimModal({ task, onClaim, onClose }) {
            let rewardMessage = '';
            let title = '–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞!'; 
            let icon = task.icon;
            let buttonText = '–ó–∞–±—Ä–∞—Ç—å!';

            if (task.type === 'tap') {
                rewardMessage = `–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ +${formatBalance(task.reward)} $NUT!`;
                icon = 'üí∞';
            } else if (task.type === 'balance') {
                rewardMessage = `–í—ã –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç–µ –±–æ–Ω—É—Å "${task.reward.name}" –Ω–∞ ${task.reward.duration} —Å–µ–∫—É–Ω–¥!`;
                icon = '‚ö°';
                buttonText = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å!';
            } else if (task.type === 'milestone') {
                rewardMessage = `–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–æ–Ω—É—Å: ${getMilestoneRewardText(task.reward)}!`;
                icon = 'üìà';
                buttonText = '–°—É–ø–µ—Ä!';
            }

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="app-modal" onClick={(e) => e.stopPropagation()}>
                        <div className="icon level-icon">{icon}</div>
                        <h3 className="success">{title}</h3>
                        <p style={{fontSize: '1.2em', fontWeight: 'bold', color: 'gold', marginBottom: '10px'}}>
                            {task.name}
                        </p>
                        <p>{rewardMessage}</p>
                        <button className="buy-btn" onClick={onClaim}>
                            {buttonText}
                        </button>
                    </div>
                </div>
            );
        }

        
        function BonusNotificationModal({ details, onClose }) {
             const titleClass = details.type === 'instant' 
                ? 'success' 
                : (details.title === '–ë–æ–Ω—É—Å –ó–∞–≤–µ—Ä—à–∏–ª—Å—è' ? 'ended' : 'max-level');
             const buttonColor = details.type === 'instant' ? '#4CAF50' : '#007BFF';

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="app-modal" onClick={(e) => e.stopPropagation()}>
                        <div className="icon level-icon">{details.icon}</div>
                        <h3 className={titleClass}>{details.title}</h3>
                        <p>
                            {details.message}
                        </p>
                        <button className="buy-btn" style={{backgroundColor: buttonColor}} onClick={onClose}>
                            {details.button}
                        </button>
                    </div>
                </div>
            );
        }

        
        // ===>>> –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ BotPurchaseModal <<<===
        function BotPurchaseModal({ onClose, rate }) {
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="app-modal" onClick={(e) => e.stopPropagation()}>
                        <div className="icon bot-icon">ü§ñ</div>
                        <h3>–ü–æ–∫—É–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
                        <p>
                            –ë–µ–ª–∫–∞-–†–æ–±–æ—Ç –∫—É–ø–ª–µ–Ω! –û–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å $NUT: 
                            <span style={{color: '#90EE90', fontWeight: 'bold'}}> +{rate} $NUT/—Å–µ–∫</span>, 
                            –ø–æ–∫–∞ –≤—ã –≤ –∏–≥—Ä–µ –∞ —Ç–∞–∫–∂–µ –∫–æ–≥–¥–∞ –æ—Ñ–ª–∞–π–Ω. –ü–æ—Å–ª–µ 2 —á–∞—Å–æ–≤ –æ—Ñ–ª–∞–π–Ω–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É!
                        </p>
                        <button className="buy-btn" style={{backgroundColor: '#007BFF'}} onClick={onClose}>
                            –û—Ç–ª–∏—á–Ω–æ!
                        </button>
                    </div>
                </div>
            );
        }
        // ===>>> –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø 2 <<<===

        
        function UpgradeSuccessModal({ upgradeId, newLevel, isMax, onClose }) {
            const upgrade = {...BOOST_CATALOG, ...DEFENSE_CATALOG}[upgradeId];
            
            const title = isMax ? "‚≠ê –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –£—Ä–æ–≤–µ–Ω—å!" : "–£–ª—É—á—à–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!";
            const titleClass = isMax ? "max-level" : "success";
            
            const message = isMax 
                ? `–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è (${upgrade.maxLevel || 'MAX'}) –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è ¬´${upgrade.name}¬ª!`
                : `–í—ã —É—Å–ø–µ—à–Ω–æ —É–ª—É—á—à–∏–ª–∏ ¬´${upgrade.name}¬ª –¥–æ —É—Ä–æ–≤–Ω—è ${newLevel}!`;
            
            const icon = isMax ? 'üëë' : upgrade.emoji;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="app-modal" onClick={(e) => e.stopPropagation()}>
                        <div className="icon level-icon">{icon}</div>
                        <h3 className={titleClass}>{title}</h3>
                        <p>{message}</p>
                        <button className="buy-btn" onClick={onClose}>
                            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                        </button>
                    </div>
                </div>
            );
        }

        
        function LockedScreen({ tab }) {
            const tabName = {
                raid: '–ù–∞–±–µ–≥',
                home: '–î—É–ø–ª–æ',
                squad: '–°—Ç–∞—è'
            }[tab];
            
            return (
                <div className="locked-screen-message">
                    <p style={{fontSize: '3em'}}>üîí</p>
                    {tabName && <h3 style={{textAlign: 'center', marginBottom: '15px'}}>{tabName}</h3>}
                    <p style={{fontSize: '1em', color: '#FFD700'}}>
                       –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–∑–∂–µ.
                    </p>
                </div>
            );
        }

        function TapAnimation({ value, x, y, color, isCritical }) {
            const style = {
                left: `${x}px`, 
                top: `${y}px`,
                color: !isCritical ? (color || 'gold') : undefined,
            };
            
            const animationClass = `tap-animation ${isCritical ? 'critical' : ''}`;
            
            return (
                <div 
                    className={animationClass} 
                    style={style}
                >
                    {value}
                </div>
            );
        }

        function Header({ balance, passiveRate }) { 
             const rateDisplay = passiveRate > 0 ? ` (+${passiveRate}/—Å–µ–∫)` : '';
             const formattedBalance = formatBalance(balance);

            return (
                <header className="header">
                    <div className="header-user">
                        <img src="images/avatar_placeholder.png" alt="User" />
                        Player_Vasya
                    </div>
                    <div className="header-balance">
                        <img src="images/nut_icon.png" alt="NUT" />
                        {formattedBalance}
                        <span style={{fontSize: '0.6em', color: '#90EE90', fontWeight: 'bold'}}>{rateDisplay}</span>
                    </div>
                </header>
            );
        }

        function EnergyBar({ energy, maxEnergy }) {
            const percentage = (energy / maxEnergy) * 100;
            return (
                <div className="energy-bar-container">
                    <div className="energy-bar-label">
                        <span>‚ö°Ô∏è –≠–Ω–µ—Ä–≥–∏—è</span>
                        <span>{Math.floor(energy)} / {maxEnergy}</span>
                    </div>
                    <div className="energy-bar-fill">
                        <div 
                            className="energy-bar-inner" 
                            style={{ width: `${percentage}%` }}>
                        </div>
                    </div>
                </div>
            );
        }

        function TabBar({ activeTab, onTabClick }) {
            const tabs = [
                { id: 'forest', name: '–õ–µ—Å', icon: 'images/icon_forest.png' },
                { id: 'boosts', name: '–ë—É—Å—Ç—ã', icon: 'images/icon_boosts.png' },
                { id: 'raid',   name: '–ù–∞–±–µ–≥', icon: 'images/icon_raid.png' },
                { id: 'home',   name: '–î—É–ø–ª–æ', icon: 'images/icon_home.png' },
                { id: 'squad',  name: '–°—Ç–∞—è', icon: 'images/icon_friends.png' }
            ];

            return (
                <nav className="tab-bar">
                    {tabs.map(tab => (
                        <div 
                            key={tab.id}
                            className={`tab-item ${activeTab === tab.id ? 'active' : ''}`}
                            onClick={() => onTabClick(tab.id)}
                        >
                            <img src={tab.icon} alt={tab.id} />
                            <span>{tab.name}</span>
                        </div>
                    ))}
                </nav>
            );
        }

        // --- –≠–∫—Ä–∞–Ω—ã ---
        
        function ForestScreen({ onTasksClick, completedTasks, onDailyRewardClick, isDailyRewardAvailable, onSettingsClick }) {
            
            // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –û–¢–°–£–¢–°–¢–í–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø (FOLBACK)
            const handleImageError = (e, fallbackEmoji) => {
                e.currentTarget.style.display = 'none'; 
                const span = document.createElement('span');
                span.textContent = fallbackEmoji;
                span.style.fontSize = '2.5em';
                span.style.color = 'white';
                span.style.textShadow = '0 0 5px black';
                e.currentTarget.parentNode.insertBefore(span, e.currentTarget);
            };

            return (
                <div className="forest-screen">
                    <button className="squirrel-btn">
                        <img src="images/squirrel_main_anim.png" alt="Tap me!" />
                    </button>
                    
                    {/* –ö–ù–û–ü–ö–ê –ï–ñ–ï–î–ù–ï–í–ù–´–• –ù–ê–ì–†–ê–î (–° —Ñ–æ–ª–±—ç–∫–æ–º üéÅ) */}
                    <button className="daily-rewards-button" onClick={onDailyRewardClick}>
                        <img 
                           src="images/icon_daily_rewards.png" 
                           alt="Daily Rewards" 
                           style={{width: '65px', height: '65px', flexShrink: 0}} 
                           onError={(e) => handleImageError(e, 'üéÅ')}
                        />
                        {isDailyRewardAvailable && (
                            <div className="notification-badge">!</div>
                        )}
                    </button>
                    
                    {/* –ö–ù–û–ü–ö–ê –ó–ê–î–ê–ù–ò–ô (–° —Ñ–æ–ª–±—ç–∫–æ–º üìã) */}
                    <button className="tasks-button" onClick={onTasksClick}>
                        <img 
                           src="images/icon_tasks.png" 
                           alt="–ó–∞–¥–∞–Ω–∏—è" 
                           style={{width: '65px', height: '65px', flexShrink: 0}} 
                           onError={(e) => handleImageError(e, 'üìã')}
                        />
                        {completedTasks > 0 && (
                            <div className="notification-badge">{completedTasks}</div>
                        )}
                    </button>
                    
                    {/* –ö–ù–û–ü–ö–ê –ù–ê–°–¢–†–û–ï–ö (–° —Ñ–æ–ª–±—ç–∫–æ–º ‚öôÔ∏è) - –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä */}
                    <button className="settings-button" onClick={onSettingsClick}>
                        <img 
                           src="images/icon_settings.png" 
                           alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" 
                           style={{width: '55px', height: '55px', flexShrink: 0}} 
                           onError={(e) => handleImageError(e, '‚öôÔ∏è')}
                        />
                    </button>
                </div>
            );
        }

        function BoostsScreen({ 
            levels, balance, passiveRatePerSec, onBuy, 
            permBonusClick, permBonusLimit, permBonusRecharge 
        }) {
             return (
                <div className="upgrade-list">
                    <div className="boost-header">
                        <h2>üöÄ –ë—É—Å—Ç—ã (–ê—Ç–∞–∫–∞ –∏ –§–∞—Ä–º)</h2>
                    </div>
                    
                    {Object.values(BOOST_CATALOG).map(upgrade => {
                        const currentLevel = levels[upgrade.id];
                        const isMaxLevel = upgrade.type === 'level' && currentLevel >= upgrade.maxLevel;
                        
                        const cost = upgrade.type === 'once' 
                            ? upgrade.baseCost 
                            : calculateCost(upgrade.baseCost, currentLevel, upgrade.id);
                        
                        let descriptionLabel = ""; 
                        let currentValue = 0;
                        let nextValue = 0;
                        let valueSuffix = ""; 

                        if (upgrade.id === 'multitap') {
                            descriptionLabel = "–î–æ–±—ã—á–∞:";
                            currentValue = (1 + levels.multitap * 1 + permBonusClick);
                            nextValue = (1 + (levels.multitap + 1) * 1 + permBonusClick);
                            valueSuffix = "$NUT/—Ç–∞–ø";
                        } else if (upgrade.id === 'energyLimit') {
                            descriptionLabel = "–õ–∏–º–∏—Ç:";
                            currentValue = BASE_ENERGY + levels.energyLimit * ENERGY_LIMIT_PER_LEVEL + permBonusLimit;
                            nextValue = currentValue + ENERGY_LIMIT_PER_LEVEL;
                            valueSuffix = "‚ö°Ô∏è";
                        } else if (upgrade.id === 'energyRecharge') {
                            descriptionLabel = "–†–µ–≥–µ–Ω:";
                            currentValue = (1 + levels.energyRecharge * ENERGY_RECHARGE_PER_LEVEL) + permBonusRecharge;
                            nextValue = currentValue + ENERGY_RECHARGE_PER_LEVEL;
                            valueSuffix = "‚ö°Ô∏è/—Å–µ–∫";
                        } else if (upgrade.id === 'autoBot') {
                             // ===>>> –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ë–µ–ª–∫–∏-–†–æ–±–æ—Ç–∞ <<<===
                             descriptionLabel = currentLevel > 0 
                                ? `–ê–∫—Ç–∏–≤–µ–Ω. –î–æ—Ö–æ–¥: +${passiveRatePerSec}/—Å–µ–∫.`
                                : `–î–æ—Ö–æ–¥: +${BASE_BOT_RATE} $NUT/—Å–µ–∫. –í –æ—Ñ—Ñ–ª–∞–π–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –±–æ–ª–µ–µ 2—á.`;
                        }
                        
                        return (
                            <UpgradeItem 
                                key={upgrade.id}
                                upgrade={upgrade} 
                                level={currentLevel}
                                cost={cost}
                                canAfford={balance >= cost}
                                onBuy={() => onBuy(upgrade.id)}
                                isMaxLevel={isMaxLevel}
                                descriptionLabel={descriptionLabel}
                                currentValue={currentValue}
                                nextValue={nextValue}
                                valueSuffix={valueSuffix}
                            />
                        );
                    })}
                </div>
            );
        }


        function HomeScreen({ levels, balance, vaultBalance, vaultCapacity, myBaseHp, onBuy, onVaultAction }) {
            return null;
        }
        
        function RaidWrapper({ /* ... */ }) {
            return null;
        }

        function RaidSearchScreen({ /* ... */ }) {
            return null;
        }
        
        function RaidBattleScreen({ /* ... */ }) {
            return null;
        }


        function SquadScreen({ friendsList, nutBonus, onCollectBonus }) {
            return null;
        }
        
        function TasksModal({ 
            onClose, totalTaps, balance, totalEarned, taskLevels, onClaim, 
            completedTapTasks, completedBalanceTasks, completedMilestoneTasks 
        }) {
            
            const [activeTaskTab, setActiveTaskTab] = useState('tap');
            
            const [infoTaskId, setInfoTaskId] = useState(null); 
            
            const tapTaskLevel = taskLevels.tap_chain;
            const tapTask = TASK_CATALOG.tap_chain[taskLevels.tap_chain];
            
            const balanceTaskLevel = taskLevels.balance_chain;
            const balanceTask = TASK_CATALOG.balance_chain[taskLevels.balance_chain];
            
            const earnedTaskLevel = taskLevels.total_earned_chain;
            const earnedTask = TASK_CATALOG.total_earned_chain[taskLevels.total_earned_chain];
            
            const infoTask = infoTaskId 
                ? (TASK_CATALOG.tap_chain.find(t => t.id === infoTaskId) || 
                   TASK_CATALOG.balance_chain.find(t => t.id === infoTaskId) ||
                   TASK_CATALOG.total_earned_chain.find(t => t.id === infoTaskId)) 
                : null;
                
            const renderTabContent = () => {
                switch(activeTaskTab) {
                    case 'tap':
                        return tapTask ? (
                            <TaskItem 
                                task={tapTask} 
                                currentProgress={totalTaps} 
                                onClaim={() => onClaim('tap_chain')} 
                                onShowInfo={() => setInfoTaskId(tapTask.id)} 
                            />
                        ) : (
                            <p>–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ —Ç–∞–ø–∞–º –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</p>
                        );
                    case 'balance':
                         return balanceTask ? (
                            <TaskItem 
                                task={balanceTask} 
                                currentProgress={balance} 
                                onClaim={() => onClaim('balance_chain')} 
                                onShowInfo={() => setInfoTaskId(balanceTask.id)} 
                            />
                        ) : (
                            <p>–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –±–∞–ª–∞–Ω—Å –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</p>
                        );
                    case 'milestone':
                        return earnedTask ? (
                            <TaskItem 
                                task={earnedTask} 
                                currentProgress={totalEarned} 
                                onClaim={() => onClaim('total_earned_chain')} 
                                onShowInfo={() => setInfoTaskId(earnedTask.id)} 
                            />
                        ) : (
                            <p>–í—Å–µ –≤–µ—Ö–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã!</p>
                        );
                    default:
                        return null;
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="tasks-modal" onClick={(e) => e.stopPropagation()}>
                        
                        {infoTask ? (
                            <div>
                                <div className="icon level-icon" style={{fontSize: '3em', marginBottom: '15px'}}>{infoTask.icon}</div>
                                <h3 className="max-level">{infoTask.name}</h3>
                                <p style={{fontSize: '1.1em', color: '#eee', lineHeight: 1.4, marginBottom: '20px'}}>
                                    {infoTask.details}
                                </p>
                                <button className="buy-btn" style={{backgroundColor: '#007BFF'}} onClick={() => setInfoTaskId(null)}>
                                    –ù–∞–∑–∞–¥
                                </button>
                            </div>
                        ) : (
                            <div>
                                <h2>–ó–∞–¥–∞–Ω–∏—è</h2>
                                
                                <div className="task-tab-bar">
                                    <div 
                                        className={`task-tab ${activeTaskTab === 'tap' ? 'active' : ''}`}
                                        onClick={() => setActiveTaskTab('tap')}
                                    >
                                        –ù–∞—á–∞–ª–æ
                                        {completedTapTasks > 0 && (
                                            <span className="task-tab-badge">{completedTapTasks}</span>
                                        )}
                                    </div>
                                    <div 
                                        className={`task-tab ${activeTaskTab === 'balance' ? 'active' : ''}`}
                                        onClick={() => setActiveTaskTab('balance')}
                                    >
                                        –°–±–µ—Ä–µ–∂–µ–Ω–∏—è
                                        {completedBalanceTasks > 0 && (
                                            <span className="task-tab-badge">{completedBalanceTasks}</span>
                                        )}
                                    </div>
                                    <div 
                                        className={`task-tab ${activeTaskTab === 'milestone' ? 'active' : ''}`}
                                        onClick={() => setActiveTaskTab('milestone')}
                                    >
                                        –ü—Ä–æ–≥—Ä–µ—Å—Å
                                        {completedMilestoneTasks > 0 && (
                                            <span className="task-tab-badge">{completedMilestoneTasks}</span>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="task-list-content">
                                    {renderTabContent()}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        function TaskItem({ task, currentProgress, onClaim, onShowInfo }) { 
            const isComplete = currentProgress >= task.target;
            const progressPercent = Math.min(100, (currentProgress / task.target) * 100);
            
            let rewardText = '...';
            if (task.type === 'tap') rewardText = `+${task.reward} $NUT`;
            if (task.type === 'balance') rewardText = 'x2';
            if (task.type === 'milestone') rewardText = getMilestoneRewardText(task.reward);

            return (
                <div className={`task-item ${isComplete ? 'is-claimable' : ''}`}>
                    <div className="icon">{task.icon}</div>
                    <div className="task-info">
                        <div className="task-title-row"> 
                            <strong>{task.name}</strong>
                            <button className="task-info-btn" onClick={onShowInfo}>i</button>
                        </div>
                        <div className="progress-text">{`–ü—Ä–æ–≥—Ä–µ—Å—Å: ${formatBalance(currentProgress)} / ${formatBalance(task.target)}`}</div>
                        <div className="progress-bar">
                            <div className="progress-bar-inner" style={{ width: `${progressPercent}%` }}></div>
                        </div>
                    </div>
                    <button 
                        className="buy-btn" 
                        disabled={!isComplete} 
                        onClick={onClaim}
                        style={{marginLeft: '10px'}}
                    >
                        {rewardText}
                    </button>
                </div>
            );
        }


        // ===>>> –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –õ–û–ì–ò–ö–ê UpgradeItem <<<===
        function UpgradeItem({ 
            upgrade, level, cost, canAfford, onBuy, isMaxLevel,
            descriptionLabel, currentValue, nextValue, valueSuffix 
        }) {
            const isPurchased = upgrade.type === 'once' && level > 0;
            
            let buttonText = '–ö—É–ø–ª–µ–Ω–æ';
            let buttonClass = 'purchased';
            let isDisabled = true;
            
            if (upgrade.type === 'level') {
                if (isMaxLevel) {
                     buttonText = '–ú–ê–ö–°.';
                     buttonClass = 'max-level'; 
                     isDisabled = true;
                } else {
                     buttonText = `–£—Ä. ${level + 1} –∑–∞ ${cost.toLocaleString('ru-RU')} $NUT`;
                     buttonClass = '';
                     isDisabled = !canAfford;
                }
            } else if (upgrade.type === 'once' && !isPurchased) {
                buttonText = `${cost.toLocaleString('ru-RU')} $NUT`;
                buttonClass = '';
                isDisabled = !canAfford;
            }

            const formatValue = (val) => val.toFixed(1).replace(/\.0$/, '');

            return (
                <div className="upgrade-item">
                    <img src={upgrade.icon} alt={upgrade.name} />
                    
                    <div className="upgrade-info">
                        <strong style={{color: 'gold'}}>{upgrade.name}</strong>
                        
                        {upgrade.type === 'level' && (
                            <div className="level-text">
                                {isMaxLevel ? `–£—Ä–æ–≤–µ–Ω—å: ${level} (MAX)` : `–£—Ä–æ–≤–µ–Ω—å: ${level}`}
                            </div>
                        )}
                        
                        <div className="description-line">
                            
                            {upgrade.type === 'level' && !isMaxLevel && (
                                <span>
                                    {descriptionLabel}
                                    {` +${formatValue(currentValue)} ${valueSuffix}`}
                                    <span className="description-line-next">
                                        {` -> +${formatValue(nextValue)} ${valueSuffix}`}
                                    </span>
                                </span>
                            )}
                            
                            {upgrade.type === 'level' && isMaxLevel && (
                                <span>
                                  {descriptionLabel}
                                  {` +${formatValue(currentValue)} ${valueSuffix}`}
                                </span>
                            )}
                            
                            {upgrade.type === 'once' && (
                                <span>{descriptionLabel}</span>
                            )}
                        </div>
                    </div>
                    
                    <button 
                        className={`buy-btn ${buttonClass}`} 
                        disabled={isDisabled}
                        onClick={onBuy}
                    >
                        {buttonText}
                    </button>
                </div>
            );
        }
        
        
        // –°—Ç–∞—Ä—Ç –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>

</body>
</html>
